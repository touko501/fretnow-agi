<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FRETNOW — Réinitialiser le mot de passe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { background: white; border-radius: 12px; padding: 40px; max-width: 420px; width: 90%; box-shadow: 0 4px 24px rgba(0,0,0,0.1); }
    .logo { text-align: center; margin-bottom: 24px; }
    .logo h1 { font-size: 28px; color: #1a1a2e; }
    .logo h1 span { color: #e94560; }
    .logo p { color: #666; font-size: 14px; margin-top: 4px; }
    h2 { font-size: 20px; margin-bottom: 8px; color: #1a1a2e; }
    .subtitle { color: #666; font-size: 14px; margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; }
    input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.2s; }
    input:focus { outline: none; border-color: #e94560; }
    .btn { width: 100%; padding: 14px; background: #e94560; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #d63853; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .message { padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .message.success { display: block; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { display: block; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .back-link { text-align: center; margin-top: 20px; }
    .back-link a { color: #e94560; text-decoration: none; font-size: 14px; }
    .password-rules { font-size: 12px; color: #888; margin-top: 4px; }
    #forgot-form, #reset-form { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>FRET<span>NOW</span></h1>
      <p>Plateforme de fret intelligent</p>
    </div>

    <div id="msg" class="message"></div>

    <!-- FORGOT PASSWORD FORM -->
    <div id="forgot-form">
      <h2>Mot de passe oublié</h2>
      <p class="subtitle">Entrez votre email pour recevoir un lien de réinitialisation.</p>
      <div class="form-group">
        <label for="forgot-email">Email</label>
        <input type="email" id="forgot-email" placeholder="votre@email.com" required>
      </div>
      <button class="btn" onclick="requestReset()">Envoyer le lien</button>
      <div class="back-link"><a href="/">← Retour à la connexion</a></div>
    </div>

    <!-- RESET PASSWORD FORM -->
    <div id="reset-form">
      <h2>Nouveau mot de passe</h2>
      <p class="subtitle">Choisissez votre nouveau mot de passe.</p>
      <div class="form-group">
        <label for="new-password">Nouveau mot de passe</label>
        <input type="password" id="new-password" placeholder="Min. 8 caractères" minlength="8" required>
        <p class="password-rules">Minimum 8 caractères</p>
      </div>
      <div class="form-group">
        <label for="confirm-password">Confirmer le mot de passe</label>
        <input type="password" id="confirm-password" placeholder="Répétez le mot de passe" required>
      </div>
      <button class="btn" onclick="resetPassword()">Réinitialiser</button>
    </div>
  </div>

  <script>
    const API = '/api/auth';
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const email = params.get('email');

    function showMsg(text, type) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.className = 'message ' + type;
    }

    // Show correct form
    if (token && email) {
      document.getElementById('reset-form').style.display = 'block';
    } else {
      document.getElementById('forgot-form').style.display = 'block';
    }

    async function requestReset() {
      const emailVal = document.getElementById('forgot-email').value.trim();
      if (!emailVal) return showMsg('Entrez votre email', 'error');

      try {
        const res = await fetch(`${API}/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: emailVal })
        });
        const data = await res.json();

        if (data.resetLink) {
          // MVP: afficher le lien directement (en prod: email uniquement)
          showMsg('Lien généré ! Cliquez ci-dessous pour réinitialiser.', 'success');
          const link = document.createElement('a');
          link.href = data.resetLink;
          link.textContent = '→ Réinitialiser mon mot de passe';
          link.style.cssText = 'display:block;text-align:center;margin-top:12px;color:#e94560;font-weight:600;';
          document.getElementById('msg').appendChild(link);
        } else {
          showMsg(data.message || 'Vérifiez votre boîte email.', 'success');
        }
      } catch (err) {
        showMsg('Erreur de connexion', 'error');
      }
    }

    async function resetPassword() {
      const pwd = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;

      if (pwd.length < 8) return showMsg('Minimum 8 caractères', 'error');
      if (pwd !== confirm) return showMsg('Les mots de passe ne correspondent pas', 'error');

      try {
        const res = await fetch(`${API}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, email: decodeURIComponent(email), newPassword: pwd })
        });
        const data = await res.json();

        if (res.ok) {
          showMsg('Mot de passe réinitialisé ! Redirection...', 'success');
          setTimeout(() => window.location.href = '/', 2000);
        } else {
          showMsg(data.error || 'Erreur', 'error');
        }
      } catch (err) {
        showMsg('Erreur de connexion', 'error');
      }
    }

    // Enter key support
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          if (token) resetPassword();
          else requestReset();
        }
      });
    });
  </script>
</body>
</html>
